name: Terraform CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: terr-bk-1
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.14.3
      - name: Terraform fmt
        run: terraform fmt -check -recursive
      - name: Terraform init
        run: terraform init -backend=false
      - name: Terraform validate
        run: terraform validate -no-color

      - name: Render architecture diagram into job summary
        if: always()
        shell: bash
        run: |
          cat > docs/architecture.mmd <<'EOF'
          flowchart LR
            subgraph Repo [Repository: backend-terraform]
              direction TB
              Root[main.tf\n(root module)]
              Root --> M_s3[modules/s3]
              Root --> M_dynamodb[modules/dynamodb]
              Examples[examples/basic\nREADME.md]
            end

            subgraph AWS [AWS]
              direction TB
              S3[S3 Bucket\n(tfstate)]
              DDB[DynamoDB Table\n(state lock)]
            end

            subgraph CI [GitHub Actions]
              direction TB
              Workflow[.github/workflows/terraform.yml\n(fmt / init / validate)]
              Runner[self-hosted runner\n(actions-runner)]
            end

            M_s3 -->|creates| S3
            M_dynamodb -->|creates| DDB
            Workflow -->|runs on| Runner
            Runner -->|executes| Workflow
            Workflow -->|command| Fmt[terraform fmt -check\n-recursive]
            Workflow -->|command| Validate[terraform init\n-backend=false && terraform validate]
            Repo -->|module source| Workflow
            Repo -->|usage example| Examples
          EOF

          # generate PNG with mermaid-cli via npx (uses Node on runner)
          if command -v npx >/dev/null 2>&1; then
            npx -y @mermaid-js/mermaid-cli -i docs/architecture.mmd -o docs/architecture.png
            echo "<p><img src=\"data:image/png;base64,$(base64 -w0 docs/architecture.png)\" alt=\"Architecture\"/></p>" >> $GITHUB_STEP_SUMMARY
          else
            echo "npx not available; diagram not rendered." >> $GITHUB_STEP_SUMMARY
          fi
